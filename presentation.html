<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto Manager - Technical Architecture & Data Flow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.0/mermaid.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'base',
            themeVariables: {
                primaryColor: '#e0e7ff',
                primaryTextColor: '#1e3a8a',
                primaryBorderColor: '#1e3a8a',
                lineColor: '#475569',
                secondaryColor: '#f0fdf4',
                tertiaryColor: '#fff1f2'
            },
            flowchart: { curve: 'basis' }
        });
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; }
        .code-font { font-family: 'JetBrains Mono', monospace; }
        
        .diagram-container {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #e2e8f0;
            margin-bottom: 2rem;
            overflow-x: auto;
        }
        
        .section-title {
            position: relative;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }
        
        .section-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 60px;
            height: 4px;
            background: #2563eb;
            border-radius: 2px;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- Navigation / Header -->
    <header class="bg-slate-900 text-white sticky top-0 z-50 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <i class="fa-solid fa-network-wired text-blue-400 text-2xl"></i>
                <h1 class="text-xl font-bold tracking-wide">Auto Manager <span class="text-slate-400 font-light text-sm">| System Architecture Document</span></h1>
            </div>
            <nav class="hidden md:flex space-x-6 text-sm">
                <a href="#stack" class="hover:text-blue-400 transition">Tech Stack</a>
                <a href="#offline-pipeline" class="hover:text-blue-400 transition">Sync Pipeline</a>
                <a href="#structure" class="hover:text-blue-400 transition">Code Structure</a>
                <a href="#linkages" class="hover:text-blue-400 transition">Code Linkages</a>
            </nav>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-10 space-y-16">

        <!-- 1. Executive Technical Summary -->
        <section>
            <div class="bg-white p-8 rounded-xl shadow-sm border-l-4 border-blue-600">
                <h2 class="text-2xl font-bold text-slate-900 mb-4">Project Overview: Hybrid/Offline-First Architecture</h2>
                <p class="text-slate-600 leading-relaxed">
                    Auto Manager is a distributed Car Rental Management System designed to solve connectivity reliability issues. 
                    Unlike traditional client-server apps, it employs a <strong>Synchronization Pipeline</strong>. 
                    The Flutter frontend writes primarily to a local <strong>SQLite</strong> database for instant feedback (Optimistic UI), 
                    while a background service orchestrates eventual consistency with the <strong>Flask/Firestore</strong> cloud backend.
                </p>
            </div>
        </section>

        <!-- 2. Technology Stack Visual -->
        <section id="stack">
            <h2 class="text-3xl font-bold text-slate-800 section-title">1. Technical Stack Decomposition</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                
                <!-- Frontend Card -->
                <div class="diagram-container border-t-4 border-t-indigo-500">
                    <h3 class="text-lg font-bold mb-4 flex items-center text-indigo-900">
                        <i class="fa-brands fa-android mr-2"></i> Client Side (Frontend)
                    </h3>
                    <div class="mermaid">
                        mindmap
                          root((Flutter App))
                            Framework
                                ::icon(fa fa-code)
                                Dart
                                Multi-Platform (Mob/Desk)
                            State Management
                                BLoC / Cubit
                                flutter_bloc
                            Persistence Layer
                                ::icon(fa fa-database)
                                SQLite
                                sqflite_ffi
                                Optimistic UI
                            Networking
                                SyncService
                                HTTP REST Client
                    </div>
                </div>

                <!-- Backend Card -->
                <div class="diagram-container border-t-4 border-t-emerald-500">
                    <h3 class="text-lg font-bold mb-4 flex items-center text-emerald-900">
                        <i class="fa-solid fa-server mr-2"></i> Server Side (Backend)
                    </h3>
                    <div class="mermaid">
                        mindmap
                          root((Flask Server))
                            Core
                                ::icon(fa fa-python)
                                Python 3
                                Flask Micro-framework
                            Data Store
                                ::icon(fa fa-cloud)
                                Google Firestore
                                firebase-admin SDK
                            Security
                                JWT Auth
                                Bcrypt Hashing
                            API
                                RESTful JSON
                                Blueprints
                    </div>
                </div>
            </div>
        </section>

        <!-- 3. The Offline-First Sync Pipeline -->
        <section id="offline-pipeline">
            <h2 class="text-3xl font-bold text-slate-800 section-title">2. The "Offline-First" Synchronization Pipeline</h2>
            <p class="mb-6 text-slate-600">
                This sequence diagram details the critical path of data from a user action to cloud consistency. 
                Note the separation between the <strong>Local Commit</strong> (instant) and <strong>Backend Ingestion</strong> (background).
            </p>
            
            <div class="diagram-container">
                <div class="mermaid">
                    sequenceDiagram
                        autonumber
                        actor User
                        participant UI as Flutter UI (Screen)
                        participant Cubit as RentalCubit (BLoC)
                        participant Repo as Local Repository
                        participant SQL as SQLite DB (Local)
                        participant Sync as SyncService (Background)
                        participant API as Flask API (Rentals.py)
                        participant Fire as Cloud Firestore

                        note over User, SQL: Phase 1: Local Commit & Optimistic UI
                        User->>UI: Creates New Rental
                        UI->>Cubit: submitRental(data)
                        Cubit->>Repo: saveRental(data)
                        Repo->>SQL: INSERT INTO rentals (..., pending_sync=1)
                        SQL-->>Repo: Success (Local ID)
                        Repo-->>Cubit: Success
                        Cubit-->>UI: Emits 'SuccessState'
                        UI-->>User: Shows "Rental Created" (Instantly)

                        note over Sync, Fire: Phase 2: Asynchronous Synchronization
                        loop Background Check
                            Sync->>SQL: SELECT * FROM rentals WHERE pending_sync=1
                            SQL-->>Sync: Returns [Rental_A]
                        end

                        Sync->>API: POST /rentals/ {json_payload}
                        
                        activate API
                        API->>API: Verify JWT Token
                        API->>API: Validate Payload -> Create Model
                        API->>Fire: db.collection('rentals').add(doc)
                        Fire-->>API: Returns Firestore Document ID (remote_id)
                        API-->>Sync: 201 Created { remote_id: "xyz123" }
                        deactivate API

                        note over Sync, SQL: Phase 3: Reconciliation
                        Sync->>SQL: UPDATE rentals SET pending_sync=0, remote_id="xyz123"
                        SQL-->>Sync: Update Complete
                </div>
            </div>
        </section>

        <!-- 4. Detailed File Structure -->
        <section id="structure">
            <h2 class="text-3xl font-bold text-slate-800 section-title">3. Detailed Project Structure & Roles</h2>
            <p class="mb-6 text-slate-600">
                A hierarchical view of the filesystem for both backend and frontend, annotating the specific responsibilities of key directories.
            </p>

            <div class="diagram-container">
                <div class="mermaid">
                    graph TD
                    %% Styles
                    classDef folder fill:#f1f5f9,stroke:#64748b,stroke-width:2px;
                    classDef file fill:#ffffff,stroke:#cbd5e1,stroke-width:1px,stroke-dasharray: 5 5;
                    classDef keyFile fill:#dbeafe,stroke:#2563eb,stroke-width:2px;

                    subgraph Backend [Backend_Original]
                        direction TB
                        B_Root[backend_original/] --> B_Run[run.py]:::keyFile
                        B_Root --> B_Req[requirements.txt]:::file
                        B_Root --> B_App[app/]:::folder
                        
                        B_App --> B_Init[__init__.py]:::keyFile
                        B_App --> B_Routes[routes/]:::folder
                        B_App --> B_DB[db/]:::folder
                        B_App --> B_Models[models/]:::folder
                        
                        B_Routes --> B_R_Auth[auth.py]:::keyFile
                        B_Routes --> B_R_Rent[rentals.py]:::keyFile
                        B_Routes --> B_R_Client[clients.py]:::file
                        
                        B_DB --> B_D_Auth[auth_service.py]:::file
                        
                        B_Models --> B_M_Py[models.py]:::keyFile
                    end

                    subgraph Frontend [Frontend]
                        direction TB
                        F_Root[frontend/lib] --> F_Main[main.dart]:::keyFile
                        F_Root --> F_Features[features/]:::folder
                        F_Root --> F_Logic[logic/cubits/]:::folder
                        F_Root --> F_DB[databases/]:::folder
                        F_Root --> F_Core[core/services/]:::folder

                        F_Features --> F_UI_Screens[auth, rentals, inventory]:::folder
                        
                        F_Logic --> F_L_Rental[rental_cubit.dart]:::file
                        F_Logic --> F_L_Auth[auth_cubit.dart]:::file
                        
                        F_DB --> F_DB_Help[dbhelper.dart]:::keyFile
                        F_DB --> F_DB_Repo[repo/repository.dart]:::keyFile
                        F_DB --> F_DB_Mod[models/rental_model.dart]:::file
                        
                        F_Core --> F_Sync[sync_service.dart]:::keyFile
                    end

                    %% Logic Links
                    B_Init -.->|Initializes| B_Routes
                    F_Sync -.->|Syncs via| F_DB_Help
                    F_DB_Repo -.->|Abstracts| F_DB_Help

                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                    <h4 class="font-bold text-blue-900 text-sm uppercase mb-2">Key Backend Correction</h4>
                    <ul class="list-disc list-inside text-sm text-slate-700 space-y-1">
                        <li><code class="code-font font-bold">app/__init__.py</code>: Now correctly shown inside the <code class="code-font">app/</code> directory where Firestore is initialized.</li>
                        <li><code class="code-font font-bold">routes/</code>: Properly contains all business logic endpoints (auth, rentals).</li>
                    </ul>
                </div>
                <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-100">
                    <h4 class="font-bold text-indigo-900 text-sm uppercase mb-2">Key Frontend Correction</h4>
                    <ul class="list-disc list-inside text-sm text-slate-700 space-y-1">
                        <li><code class="code-font font-bold">databases/</code>: Organized into <code class="code-font">repo/</code> for high-level abstraction and <code class="code-font">dbhelper.dart</code> for raw SQL.</li>
                        <li><code class="code-font font-bold">sync_service.dart</code>: Positioned in <code class="code-font">core/services/</code> as a cross-cutting concern.</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- 5. Code Linkage Flow -->
        <section id="linkages">
            <h2 class="text-3xl font-bold text-slate-800 section-title">4. Cross-System Code Linkages</h2>
            <p class="mb-6 text-slate-600">
                This diagram visualizes exactly which file in the frontend talks to which file in the backend, and what data structures connect them.
            </p>
            
            <div class="diagram-container">
                <div class="mermaid">
                    flowchart LR
                        %% Nodes
                        subgraph ClientSide [Flutter Client]
                            LoginScreen[Login UI<br/>features/auth/...]
                            Sync[SyncService<br/>core/services/sync_service.dart]
                            RentalModel[Rental Model<br/>databases/.../rental_model.dart]
                            LocalDB[(SQLite<br/>databases/dbhelper.dart)]
                        end

                        subgraph ServerSide [Flask Server]
                            AuthRoute[Auth Route<br/>app/routes/auth.py]
                            RentalRoute[Rental Route<br/>app/routes/rentals.py]
                            PyModel[Python Class<br/>app/models/models.py]
                            Init[App Init<br/>app/__init__.py]
                        end

                        %% Connections
                        LoginScreen -- "POST /login (Credentials)" --> AuthRoute
                        AuthRoute -- "Returns JWT" --> LoginScreen
                        
                        Sync -- "POST /rentals (Dirty Data)" --> RentalRoute
                        RentalRoute -- "Validates Structure" --> PyModel
                        RentalModel -. "Matches Structure" .- PyModel
                        
                        Sync -- "Reads pending_sync=1" --> LocalDB
                        RentalRoute -- "Writes to Firestore" --> Init

                        %% Styling
                        linkStyle 0 stroke:#2563eb,stroke-width:2px;
                        linkStyle 2 stroke:#059669,stroke-width:2px;
                        linkStyle 5 stroke:#db2777,stroke-width:2px,stroke-dasharray: 5 5;
                </div>
            </div>
            
            <div class="overflow-hidden bg-white shadow sm:rounded-lg border border-gray-200">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Interaction Type</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Frontend Source</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Backend Target</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Protocol</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Authentication</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 code-font">login_screen.dart</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 code-font">auth.py (/login)</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600">JWT / REST</td>
                        </tr>
                        <tr class="bg-slate-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Data Synchronization</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 code-font">sync_service.dart (Line 38)</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 code-font">rentals.py (Line 10)</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600">REST POST</td>
                        </tr>
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Database Connection</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 code-font">dbhelper.dart</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 code-font">__init__.py (Firestore)</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600">Internal Drivers</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

    </main>

    <footer class="bg-slate-900 text-slate-400 py-8 mt-12">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <p class="text-sm">Auto Manager Project Documentation.</p>
        </div>
    </footer>

</body>
</html>